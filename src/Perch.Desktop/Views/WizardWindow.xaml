<ui:FluentWindow
    x:Class="Perch.Desktop.Views.WizardWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:vm="clr-namespace:Perch.Desktop.ViewModels.Wizard"
    xmlns:deploy="clr-namespace:Perch.Core.Deploy;assembly=Perch.Core"
    d:DataContext="{d:DesignInstance vm:WizardShellViewModel}"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Title="Perch Setup Wizard"
    Icon="/Assets/logo.png"
    Width="1050"
    Height="720"
    MinWidth="800"
    MinHeight="550"
    WindowStartupLocation="CenterScreen"
    ExtendsContentIntoTitleBar="True">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Title Bar -->
        <ui:TitleBar Grid.Row="0" Title="Perch Setup" />

        <!-- Step Content -->
        <Grid Grid.Row="1">

            <!-- Step 0: Welcome / Profile Selection -->
            <Grid Visibility="{Binding CurrentStepIndex, Converter={StaticResource IndexToVisibilityConverter}, ConverterParameter=0}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- Startpage hero -->
                <Border Grid.Row="0" Height="180" ClipToBounds="True" Margin="24,8,24,0" CornerRadius="8">
                    <Border.Background>
                        <ImageBrush ImageSource="/Assets/startpage.png" Stretch="UniformToFill" AlignmentY="Center" />
                    </Border.Background>
                    <Border Background="#88000000" Padding="24,0">
                        <StackPanel VerticalAlignment="Center">
                            <ui:TextBlock FontTypography="TitleLarge" Foreground="White" Text="Welcome to Perch" />
                            <ui:TextBlock FontTypography="Body" Foreground="#CCFFFFFF" Margin="0,4,0,0"
                                Text="Select your profile to get started. This determines which configs and tweaks are suggested for you." />
                        </StackPanel>
                    </Border>
                </Border>

                <ui:TextBlock Grid.Row="1" FontTypography="Subtitle" Margin="24,16,24,8" Text="Choose your profile" />

                <!-- Profile cards - responsive grid -->
                <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" Margin="24,0">
                    <UniformGrid Rows="1" Margin="0,0,0,12">
                        <!-- Developer -->
                        <Border Margin="0,0,8,0" MinHeight="200" CornerRadius="8" ClipToBounds="True"
                                MouseLeftButtonUp="OnProfileCardClick" Tag="Developer" Cursor="Hand"
                                BorderThickness="3"
                                BorderBrush="{Binding ProfileSelection.IsDeveloper, Converter={StaticResource BooleanToBorderBrushConverter}}">
                            <Border.Background>
                                <ImageBrush ImageSource="/Assets/profile-developer.png" Stretch="UniformToFill" />
                            </Border.Background>
                            <Border Padding="16" VerticalAlignment="Bottom">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                        <GradientStop Color="#00000000" Offset="0" />
                                        <GradientStop Color="#DD000000" Offset="1" />
                                    </LinearGradientBrush>
                                </Border.Background>
                                <StackPanel>
                                    <Grid>
                                        <ui:TextBlock FontTypography="BodyStrong" Foreground="White" Text="Developer" />
                                        <CheckBox HorizontalAlignment="Right" IsChecked="{Binding ProfileSelection.IsDeveloper}" IsHitTestVisible="False" />
                                    </Grid>
                                    <ui:TextBlock FontTypography="Caption" Foreground="#AAFFFFFF" TextWrapping="Wrap"
                                        Text="Full dotfiles, dev tools, shell configs" />
                                </StackPanel>
                            </Border>
                        </Border>

                        <!-- Power User -->
                        <Border Margin="4,0" MinHeight="200" CornerRadius="8" ClipToBounds="True"
                                MouseLeftButtonUp="OnProfileCardClick" Tag="PowerUser" Cursor="Hand"
                                BorderThickness="3"
                                BorderBrush="{Binding ProfileSelection.IsPowerUser, Converter={StaticResource BooleanToBorderBrushConverter}}">
                            <Border.Background>
                                <ImageBrush ImageSource="/Assets/profile-power-user.png" Stretch="UniformToFill" />
                            </Border.Background>
                            <Border Padding="16" VerticalAlignment="Bottom">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                        <GradientStop Color="#00000000" Offset="0" />
                                        <GradientStop Color="#DD000000" Offset="1" />
                                    </LinearGradientBrush>
                                </Border.Background>
                                <StackPanel>
                                    <Grid>
                                        <ui:TextBlock FontTypography="BodyStrong" Foreground="White" Text="Power User" />
                                        <CheckBox HorizontalAlignment="Right" IsChecked="{Binding ProfileSelection.IsPowerUser}" IsHitTestVisible="False" />
                                    </Grid>
                                    <ui:TextBlock FontTypography="Caption" Foreground="#AAFFFFFF" TextWrapping="Wrap"
                                        Text="System tweaks, app settings" />
                                </StackPanel>
                            </Border>
                        </Border>

                        <!-- Gamer -->
                        <Border Margin="4,0" MinHeight="200" CornerRadius="8" ClipToBounds="True"
                                MouseLeftButtonUp="OnProfileCardClick" Tag="Gamer" Cursor="Hand"
                                BorderThickness="3"
                                BorderBrush="{Binding ProfileSelection.IsGamer, Converter={StaticResource BooleanToBorderBrushConverter}}">
                            <Border.Background>
                                <ImageBrush ImageSource="/Assets/profile-gamer.png" Stretch="UniformToFill" />
                            </Border.Background>
                            <Border Padding="16" VerticalAlignment="Bottom">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                        <GradientStop Color="#00000000" Offset="0" />
                                        <GradientStop Color="#DD000000" Offset="1" />
                                    </LinearGradientBrush>
                                </Border.Background>
                                <StackPanel>
                                    <Grid>
                                        <ui:TextBlock FontTypography="BodyStrong" Foreground="White" Text="Gamer" />
                                        <CheckBox HorizontalAlignment="Right" IsChecked="{Binding ProfileSelection.IsGamer}" IsHitTestVisible="False" />
                                    </Grid>
                                    <ui:TextBlock FontTypography="Caption" Foreground="#AAFFFFFF" TextWrapping="Wrap"
                                        Text="Gaming apps, performance tweaks" />
                                </StackPanel>
                            </Border>
                        </Border>

                        <!-- Creative -->
                        <Border Margin="4,0" MinHeight="200" CornerRadius="8" ClipToBounds="True"
                                MouseLeftButtonUp="OnProfileCardClick" Tag="Creative" Cursor="Hand"
                                BorderThickness="3"
                                BorderBrush="{Binding ProfileSelection.IsCreative, Converter={StaticResource BooleanToBorderBrushConverter}}">
                            <Border.Background>
                                <ImageBrush ImageSource="/Assets/profile-creative.png" Stretch="UniformToFill" />
                            </Border.Background>
                            <Border Padding="16" VerticalAlignment="Bottom">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                        <GradientStop Color="#00000000" Offset="0" />
                                        <GradientStop Color="#DD000000" Offset="1" />
                                    </LinearGradientBrush>
                                </Border.Background>
                                <StackPanel>
                                    <Grid>
                                        <ui:TextBlock FontTypography="BodyStrong" Foreground="White" Text="Creative" />
                                        <CheckBox HorizontalAlignment="Right" IsChecked="{Binding ProfileSelection.IsCreative}" IsHitTestVisible="False" />
                                    </Grid>
                                    <ui:TextBlock FontTypography="Caption" Foreground="#AAFFFFFF" TextWrapping="Wrap"
                                        Text="Design tools, media apps, fonts" />
                                </StackPanel>
                            </Border>
                        </Border>

                        <!-- Casual -->
                        <Border Margin="8,0,0,0" MinHeight="200" CornerRadius="8" ClipToBounds="True"
                                MouseLeftButtonUp="OnProfileCardClick" Tag="Casual" Cursor="Hand"
                                BorderThickness="3"
                                BorderBrush="{Binding ProfileSelection.IsCasual, Converter={StaticResource BooleanToBorderBrushConverter}}">
                            <Border.Background>
                                <ImageBrush ImageSource="/Assets/profile-casual2.png" Stretch="UniformToFill" />
                            </Border.Background>
                            <Border Padding="16" VerticalAlignment="Bottom">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                        <GradientStop Color="#00000000" Offset="0" />
                                        <GradientStop Color="#DD000000" Offset="1" />
                                    </LinearGradientBrush>
                                </Border.Background>
                                <StackPanel>
                                    <Grid>
                                        <ui:TextBlock FontTypography="BodyStrong" Foreground="White" Text="Casual" />
                                        <CheckBox HorizontalAlignment="Right" IsChecked="{Binding ProfileSelection.IsCasual}" IsHitTestVisible="False" />
                                    </Grid>
                                    <ui:TextBlock FontTypography="Caption" Foreground="#AAFFFFFF" TextWrapping="Wrap"
                                        Text="Simplified experience, apps only" />
                                </StackPanel>
                            </Border>
                        </Border>
                    </UniformGrid>
                </ScrollViewer>
            </Grid>

            <!-- Step 1: Dotfiles Selection -->
            <Grid Visibility="{Binding CurrentStepIndex, Converter={StaticResource IndexToVisibilityConverter}, ConverterParameter=1}"
                  Margin="24,16">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <ui:TextBlock Grid.Row="0" FontTypography="Title" Text="Dotfiles &amp; Config" />
                <ui:TextBlock Grid.Row="1" FontTypography="Body" Opacity="0.6" Margin="0,4,0,16"
                    Text="Select which config modules to deploy. Each module symlinks its config files so changes are instantly tracked in git." />

                <!-- Loading -->
                <StackPanel Grid.Row="2" VerticalAlignment="Center" HorizontalAlignment="Center"
                            Visibility="{Binding IsLoadingModules, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <ui:ProgressRing IsIndeterminate="True" Width="32" Height="32" Margin="0,0,0,8" />
                    <ui:TextBlock FontTypography="Caption" Opacity="0.6" Text="Scanning modules..." HorizontalAlignment="Center" />
                </StackPanel>

                <!-- Module list -->
                <ListView Grid.Row="2" ItemsSource="{Binding DotfileModules}"
                          ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                          Visibility="{Binding IsLoadingModules, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                    <ListView.ItemTemplate>
                        <DataTemplate DataType="{x:Type vm:WizardModuleViewModel}">
                            <Border Padding="12,8" Margin="0,0,0,2" CornerRadius="4"
                                    Background="{DynamicResource ControlFillColorDefaultBrush}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <CheckBox Grid.Column="0" IsChecked="{Binding IsSelected}" Margin="0,0,12,0"
                                              Checked="OnModuleChecked" Unchecked="OnModuleUnchecked" />
                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                        <ui:TextBlock FontTypography="BodyStrong" Text="{Binding DisplayName}" />
                                        <ui:TextBlock FontTypography="Caption" Opacity="0.6" Text="{Binding Description}" />
                                    </StackPanel>
                                    <ui:TextBlock Grid.Column="2" FontTypography="Caption" Opacity="0.4"
                                                  VerticalAlignment="Center" Text="{Binding Name}" />
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </Grid>

            <!-- Step 2: Apps Selection -->
            <Grid Visibility="{Binding CurrentStepIndex, Converter={StaticResource IndexToVisibilityConverter}, ConverterParameter=2}"
                  Margin="24,16">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <ui:TextBlock Grid.Row="0" FontTypography="Title" Text="Applications" />
                <ui:TextBlock Grid.Row="1" FontTypography="Body" Opacity="0.6" Margin="0,4,0,16"
                    Text="Review the applications detected from your config repository." />

                <ListView Grid.Row="2" ItemsSource="{Binding Apps}"
                          ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                    <ListView.ItemTemplate>
                        <DataTemplate DataType="{x:Type vm:WizardAppViewModel}">
                            <Border Padding="12,8" Margin="0,0,0,2" CornerRadius="4"
                                    Background="{DynamicResource ControlFillColorDefaultBrush}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <CheckBox Grid.Column="0" IsChecked="{Binding IsSelected}" Margin="0,0,12,0" />
                                    <ui:TextBlock Grid.Column="1" FontTypography="BodyStrong" VerticalAlignment="Center" Text="{Binding Name}" />
                                    <Border Grid.Column="2" CornerRadius="4" Padding="8,2" VerticalAlignment="Center">
                                        <ui:TextBlock FontTypography="Caption" Opacity="0.5" Text="{Binding CategoryDisplay}" />
                                    </Border>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </Grid>

            <!-- Step 3: System Tweaks Selection -->
            <Grid Visibility="{Binding CurrentStepIndex, Converter={StaticResource IndexToVisibilityConverter}, ConverterParameter=3}"
                  Margin="24,16">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <ui:TextBlock Grid.Row="0" FontTypography="Title" Text="System Tweaks" />
                <ui:TextBlock Grid.Row="1" FontTypography="Body" Opacity="0.6" Margin="0,4,0,16"
                    Text="Select registry tweaks to apply. These modify Windows system settings to match your preferred configuration." />

                <ListView Grid.Row="2" ItemsSource="{Binding TweakModules}"
                          ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                    <ListView.ItemTemplate>
                        <DataTemplate DataType="{x:Type vm:WizardTweakModuleViewModel}">
                            <Border Padding="12,8" Margin="0,0,0,2" CornerRadius="4"
                                    Background="{DynamicResource ControlFillColorDefaultBrush}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <CheckBox Grid.Column="0" IsChecked="{Binding IsSelected}" Margin="0,0,12,0"
                                              Checked="OnModuleChecked" Unchecked="OnModuleUnchecked" />
                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                        <ui:TextBlock FontTypography="BodyStrong" Text="{Binding DisplayName}" />
                                        <ui:TextBlock FontTypography="Caption" Opacity="0.6" Text="{Binding Description}" />
                                    </StackPanel>
                                    <ui:TextBlock Grid.Column="2" FontTypography="Caption" Opacity="0.4"
                                                  VerticalAlignment="Center" Text="{Binding Name}" />
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </Grid>

            <!-- Step 4: Review -->
            <Grid Visibility="{Binding CurrentStepIndex, Converter={StaticResource IndexToVisibilityConverter}, ConverterParameter=4}"
                  Margin="24,16">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" MaxWidth="500">
                    <Grid Height="260" Margin="0,0,0,0">
                        <Image Source="/Assets/wizard-empty.png" Stretch="Uniform" />
                        <StackPanel VerticalAlignment="Bottom" HorizontalAlignment="Center" Margin="0,0,0,24">
                            <ui:TextBlock FontTypography="Title" HorizontalAlignment="Center" Foreground="White" Text="Ready to deploy" />
                            <ui:TextBlock FontTypography="Body" Opacity="0.7" HorizontalAlignment="Center" Margin="0,4,0,0"
                                Foreground="White" TextWrapping="Wrap" TextAlignment="Center"
                                Text="{Binding TotalSelectedCount, StringFormat='{}{0} modules selected'}" />
                        </StackPanel>
                    </Grid>
                    <ui:TextBlock FontTypography="Body" Opacity="0.6" HorizontalAlignment="Center" Margin="0,16,0,0"
                        TextWrapping="Wrap" TextAlignment="Center"
                        Text="Perch will scan your config repository and create symlinks for all selected modules. Existing files will be backed up." />
                </StackPanel>
            </Grid>

            <!-- Step 5: Deploy / Results -->
            <Grid Visibility="{Binding CurrentStepIndex, Converter={StaticResource IndexToVisibilityConverter}, ConverterParameter=5}"
                  Margin="24,16">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- Completion images -->
                <Grid Grid.Row="0" HorizontalAlignment="Center" Margin="0,0,0,16"
                      Visibility="{Binding IsComplete, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <Image Source="/Assets/wizard-success.png" Width="180" Height="180"
                           Visibility="{Binding HasErrors, Converter={StaticResource InverseBooleanToVisibilityConverter}}" />
                    <Image Source="/Assets/wizard-error.png" Width="180" Height="180"
                           Visibility="{Binding HasErrors, Converter={StaticResource BooleanToVisibilityConverter}}" />
                </Grid>

                <!-- Progress -->
                <StackPanel Grid.Row="1" HorizontalAlignment="Center">
                    <ui:ProgressRing IsIndeterminate="True" Width="32" Height="32" Margin="0,0,0,8"
                        Visibility="{Binding IsDeploying, Converter={StaticResource BooleanToVisibilityConverter}}" />
                    <ui:TextBlock FontTypography="Subtitle" HorizontalAlignment="Center" Text="{Binding DeployStatusMessage}" />
                    <ui:TextBlock FontTypography="Caption" Opacity="0.6" HorizontalAlignment="Center" Margin="0,4,0,0">
                        <ui:TextBlock.Text>
                            <MultiBinding StringFormat="{}{0} deployed, {1} errors">
                                <Binding Path="DeployedCount" />
                                <Binding Path="ErrorCount" />
                            </MultiBinding>
                        </ui:TextBlock.Text>
                    </ui:TextBlock>
                </StackPanel>

                <!-- Deploy results list -->
                <ListView Grid.Row="2" Margin="0,16,0,0" ItemsSource="{Binding DeployResults}"
                    ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                    <ListView.ItemTemplate>
                        <DataTemplate DataType="{x:Type vm:DeployResultItemViewModel}">
                            <Grid Margin="0,2">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <ui:SymbolIcon Grid.Column="0" Margin="0,0,8,0">
                                    <ui:SymbolIcon.Style>
                                        <Style TargetType="ui:SymbolIcon">
                                            <Setter Property="Symbol" Value="CheckmarkCircle24" />
                                            <Setter Property="Foreground" Value="#34D399" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Level}" Value="{x:Static deploy:ResultLevel.Error}">
                                                    <Setter Property="Symbol" Value="ErrorCircle24" />
                                                    <Setter Property="Foreground" Value="#EF4444" />
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Level}" Value="{x:Static deploy:ResultLevel.Warning}">
                                                    <Setter Property="Symbol" Value="Warning24" />
                                                    <Setter Property="Foreground" Value="#F59E0B" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </ui:SymbolIcon.Style>
                                </ui:SymbolIcon>
                                <ui:TextBlock Grid.Column="1" FontTypography="Caption" Text="{Binding ModuleName}" Margin="0,0,8,0" />
                                <ui:TextBlock Grid.Column="2" FontTypography="Caption" Opacity="0.6" Text="{Binding Message}" TextTrimming="CharacterEllipsis" />
                            </Grid>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </Grid>
        </Grid>

        <!-- Footer navigation -->
        <Border Grid.Row="2" Padding="24,12" Background="{DynamicResource ControlFillColorDefaultBrush}">
            <Grid>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                    <ui:Button Content="Back" Command="{Binding GoBackCommand}"
                        Visibility="{Binding CanGoBack, Converter={StaticResource BooleanToVisibilityConverter}}" />
                </StackPanel>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <ui:Button Content="Next" Appearance="Primary" Command="{Binding GoNextCommand}"
                        Visibility="{Binding CanGoNext, Converter={StaticResource BooleanToVisibilityConverter}}" />
                    <ui:Button Content="Deploy" Appearance="Primary" Command="{Binding DeployCommand}"
                        Visibility="{Binding ShowDeploy, Converter={StaticResource BooleanToVisibilityConverter}}" />
                    <ui:Button Content="Open Dashboard" Appearance="Primary" Click="OnOpenDashboard"
                        Visibility="{Binding IsComplete, Converter={StaticResource BooleanToVisibilityConverter}}" />
                </StackPanel>
            </Grid>
        </Border>
    </Grid>

</ui:FluentWindow>
